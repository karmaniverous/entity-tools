<!DOCTYPE html><html class="default" lang="en" data-base="./"><head><meta charset="utf-8"/><link rel="canonical" href="https://docs.karmanivero.us/entity-tools/"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>@karmaniverous/entity-tools</title><meta name="description" content="Documentation for @karmaniverous/entity-tools"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="assets/style.css"/><link rel="stylesheet" href="assets/highlight.css"/><script defer src="assets/main.js"></script><script async src="assets/icons.js" id="tsd-icons-script"></script><script async src="assets/search.js" id="tsd-search-script"></script><script async src="assets/navigation.js" id="tsd-nav-script"></script></head><body><script>document.documentElement.dataset.theme = localStorage.getItem("tsd-theme") || "os";document.body.style.display="none";setTimeout(() => window.app?app.showPage():document.body.style.removeProperty("display"),500)</script><header class="tsd-page-toolbar"><div class="tsd-toolbar-contents container"><a href="index.html" class="title">@karmaniverous/entity-tools</a><div id="tsd-toolbar-links"><a href="https://github.com/karmaniverous/entity-tools">GitHub</a></div><button id="tsd-search-trigger" class="tsd-widget" aria-label="Search"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="assets/icons.svg#icon-search"></use></svg></button><dialog id="tsd-search" aria-label="Search"><input role="combobox" id="tsd-search-input" aria-controls="tsd-search-results" aria-autocomplete="list" aria-expanded="true" autocapitalize="off" autocomplete="off" placeholder="Search the docs" maxLength="100"/><ul role="listbox" id="tsd-search-results"></ul><div id="tsd-search-status" aria-live="polite" aria-atomic="true"><div>Preparing search index...</div></div></dialog><a href="#" class="tsd-widget menu" id="tsd-toolbar-menu-trigger" data-toggle="menu" aria-label="Menu"><svg width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true"><use href="assets/icons.svg#icon-menu"></use></svg></a></div></header><div class="container container-main"><div class="col-content"><div class="tsd-page-title"><h1>@karmaniverous/entity-tools</h1></div><div class="tsd-panel tsd-typography"><h1 id="entity-tools" class="tsd-anchor-link">Entity Tools<a href="#entity-tools" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h1><p><a href="https://www.npmjs.com/package/@karmaniverous/entity-tools" target="_blank" class="external"><img src="https://img.shields.io/npm/v/@karmaniverous/entity-tools.svg" alt="npm version"></a> <img src="https://img.shields.io/node/v/@karmaniverous/entity-tools" alt="Node Current">  <a href="https://github.com/karmaniverous/entity-tools/tree/main/LICENSE.md" target="_blank" class="external"><img src="https://img.shields.io/badge/license-BSD--3--Clause-blue.svg" alt="license"></a></p>
<p>Entity Tools provides a compact set of runtime utilities and type-level helpers for working with data models (Entities), sorting, shallow updates, and safe transcoding between values and lexicographically sortable strings.</p>
<ul>
<li>Small surface area, zero runtime dependencies beyond radash.</li>
<li>Strong TypeScript support with dedicated type tests (tsd).</li>
<li>Works great standalone or together with:
<ul>
<li><a href="https://github.com/karmaniverous/entity-manager" target="_blank" class="external">entity-manager</a></li>
<li><a href="https://github.com/karmaniverous/entity-client-dynamodb" target="_blank" class="external">entity-client-dynamodb</a></li>
<li><a href="https://github.com/karmaniverous/mock-db" target="_blank" class="external">mock-db</a></li>
</ul>
</li>
</ul>
<h2 id="installation" class="tsd-anchor-link">Installation<a href="#installation" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><pre><code class="bash"><span class="hl-0">npm</span><span class="hl-1"> </span><span class="hl-2">i</span><span class="hl-1"> </span><span class="hl-2">@karmaniverous/entity-tools</span><br/><span class="hl-3"># or: pnpm add @karmaniverous/entity-tools</span><br/><span class="hl-3"># or: yarn add @karmaniverous/entity-tools</span>
</code><button type="button">Copy</button></pre>

<h2 id="exports-overview" class="tsd-anchor-link">Exports overview<a href="#exports-overview" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Runtime utilities</p>
<ul>
<li>conditionalize(fn, condition?): wrap a function so it only runs when condition is truthy; otherwise returns undefined.</li>
<li>defaultTranscodes: ready-made Transcodes supporting the DefaultTranscodeRegistry (boolean, string, number, fix6, int, bigint, bigint20, timestamp).</li>
<li>isNil(value): Nil type-guard (null | undefined).</li>
<li>sort(items, sortOrder): stable, progressive sort over Entity properties (numbers, strings, bigints, null/undefined, and truthiness fallback).</li>
<li>updateItem(record, update): shallow update that ignores undefined, assigns nulls, and removes null/undefined from the result.</li>
</ul>
<p>Core types (entities and sorting)</p>
<ul>
<li>Entity: base Record&lt;string, unknown&gt; you can extend for your models.</li>
<li>EntityMap: map of named entities.</li>
<li>Exactify<T>: strip index signatures from records.</li>
<li>EntityKeys<E>, EntityValue&lt;E, K&gt;, EntityMapValues<M>, FlattenEntityMap<M></li>
<li>SortOrder<E>: sort descriptor for sort().</li>
</ul>
<p>Transcoding types</p>
<ul>
<li>TranscodeRegistry (canonical): relates transcode keys to the types they encode (e.g., <code>int → number</code>).</li>
<li>DefaultTranscodeRegistry: a concrete TranscodeRegistry shipped by this package.</li>
<li>Transcodes<TR>: shape of an encode/decode registry for a TranscodeRegistry.</li>
<li>TranscodeRegistryFrom<T>: derives a TranscodeRegistry type from a record of transcoders by mapping each key to ReturnType<decode>.</li>
<li>TranscodedType&lt;TR, TN&gt;, TranscodeName<TR></li>
</ul>
<p>Type utilities</p>
<ul>
<li>ConditionalProperty&lt;K, C, O&gt;, MakeOptional&lt;T, K&gt;, MakeRequired&lt;T, K&gt;, MakeUpdatable&lt;T, K&gt;, WithRequiredAndNonNullable&lt;T, K&gt;</li>
<li>AllDisjoint&lt;First, Rest&gt;, MutuallyExclusive<T></li>
<li>NotNever&lt;T, Keys&gt;, PropertiesOfType&lt;O, T&gt;, PropertiesNotOfType&lt;O, T&gt;</li>
<li>ReplaceKey&lt;T, K, R&gt;, ReplaceKeys&lt;T, R&gt;</li>
<li>Nil (type alias for null | undefined)</li>
</ul>
<p>Full reference: see API docs linked at the top of this README.</p>
<h2 id="quick-examples" class="tsd-anchor-link">Quick examples<a href="#quick-examples" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><p>Sorting</p>
<pre><code class="ts"><span class="hl-4">import</span><span class="hl-1"> { </span><span class="hl-5">sort</span><span class="hl-1">, </span><span class="hl-4">type</span><span class="hl-1"> </span><span class="hl-5">SortOrder</span><span class="hl-1"> } </span><span class="hl-4">from</span><span class="hl-1"> </span><span class="hl-2">&#39;@karmaniverous/entity-tools&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-6">type</span><span class="hl-1"> </span><span class="hl-7">User</span><span class="hl-1"> = {</span><br/><span class="hl-1">  </span><span class="hl-5">id</span><span class="hl-1">: </span><span class="hl-7">number</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-5">name</span><span class="hl-1">: </span><span class="hl-7">string</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-5">optional</span><span class="hl-1">?: </span><span class="hl-7">string</span><span class="hl-1"> | </span><span class="hl-7">null</span><span class="hl-1">;</span><br/><span class="hl-1">  </span><span class="hl-5">data</span><span class="hl-1">?: </span><span class="hl-7">object</span><span class="hl-1">;</span><br/><span class="hl-1">};</span><br/><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-8">users</span><span class="hl-1">: </span><span class="hl-7">User</span><span class="hl-1">[] = [</span><br/><span class="hl-1">  { </span><span class="hl-5">id:</span><span class="hl-1"> </span><span class="hl-9">2</span><span class="hl-1">, </span><span class="hl-5">name:</span><span class="hl-1"> </span><span class="hl-2">&#39;Adam&#39;</span><span class="hl-1">, </span><span class="hl-5">optional:</span><span class="hl-1"> </span><span class="hl-2">&#39;foo&#39;</span><span class="hl-1">, </span><span class="hl-5">data:</span><span class="hl-1"> { </span><span class="hl-5">foo:</span><span class="hl-1"> </span><span class="hl-2">&#39;bar&#39;</span><span class="hl-1"> } },</span><br/><span class="hl-1">  { </span><span class="hl-5">id:</span><span class="hl-1"> </span><span class="hl-9">3</span><span class="hl-1">, </span><span class="hl-5">name:</span><span class="hl-1"> </span><span class="hl-2">&#39;Bob&#39;</span><span class="hl-1">, </span><span class="hl-5">optional:</span><span class="hl-1"> </span><span class="hl-2">&#39;bar&#39;</span><span class="hl-1">, </span><span class="hl-5">data:</span><span class="hl-1"> { </span><span class="hl-5">bar:</span><span class="hl-1"> </span><span class="hl-2">&#39;baz&#39;</span><span class="hl-1"> } },</span><br/><span class="hl-1">  { </span><span class="hl-5">id:</span><span class="hl-1"> </span><span class="hl-9">1</span><span class="hl-1">, </span><span class="hl-5">name:</span><span class="hl-1"> </span><span class="hl-2">&#39;Charlie&#39;</span><span class="hl-1">, </span><span class="hl-5">optional:</span><span class="hl-1"> </span><span class="hl-6">null</span><span class="hl-1">, </span><span class="hl-5">data:</span><span class="hl-1"> { </span><span class="hl-5">baz:</span><span class="hl-1"> </span><span class="hl-2">&#39;qux&#39;</span><span class="hl-1"> } },</span><br/><span class="hl-1">  { </span><span class="hl-5">id:</span><span class="hl-1"> </span><span class="hl-9">4</span><span class="hl-1">, </span><span class="hl-5">name:</span><span class="hl-1"> </span><span class="hl-2">&#39;Adam&#39;</span><span class="hl-1"> },</span><br/><span class="hl-1">];</span><br/><br/><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-8">order</span><span class="hl-1">: </span><span class="hl-7">SortOrder</span><span class="hl-1">&lt;</span><span class="hl-7">User</span><span class="hl-1">&gt; = [</span><br/><span class="hl-1">  { </span><span class="hl-5">property:</span><span class="hl-1"> </span><span class="hl-2">&#39;name&#39;</span><span class="hl-1"> },</span><br/><span class="hl-1">  { </span><span class="hl-5">property:</span><span class="hl-1"> </span><span class="hl-2">&#39;id&#39;</span><span class="hl-1">, </span><span class="hl-5">desc:</span><span class="hl-1"> </span><span class="hl-6">true</span><span class="hl-1"> },</span><br/><span class="hl-1">];</span><br/><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-8">result</span><span class="hl-1"> = </span><span class="hl-0">sort</span><span class="hl-1">(</span><span class="hl-5">users</span><span class="hl-1">, </span><span class="hl-5">order</span><span class="hl-1">);</span><br/><span class="hl-3">// [</span><br/><span class="hl-3">//   { id: 4, name: &#39;Adam&#39; },</span><br/><span class="hl-3">//   { id: 2, name: &#39;Adam&#39;, optional: &#39;foo&#39;, data: { foo: &#39;bar&#39; } },</span><br/><span class="hl-3">//   { id: 3, name: &#39;Bob&#39;, optional: &#39;bar&#39;, data: { bar: &#39;baz&#39; } },</span><br/><span class="hl-3">//   { id: 1, name: &#39;Charlie&#39;, optional: null, data: { baz: &#39;qux&#39; } },</span><br/><span class="hl-3">// ]</span>
</code><button type="button">Copy</button></pre>

<p>Shallow updates</p>
<pre><code class="ts"><span class="hl-4">import</span><span class="hl-1"> { </span><span class="hl-5">updateItem</span><span class="hl-1"> } </span><span class="hl-4">from</span><span class="hl-1"> </span><span class="hl-2">&#39;@karmaniverous/entity-tools&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-8">original</span><span class="hl-1"> = {</span><br/><span class="hl-1">  </span><span class="hl-5">id:</span><span class="hl-1"> </span><span class="hl-9">1</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">name:</span><span class="hl-1"> </span><span class="hl-2">&#39;Alice&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">note:</span><span class="hl-1"> </span><span class="hl-6">undefined</span><span class="hl-1"> </span><span class="hl-4">as</span><span class="hl-1"> </span><span class="hl-7">string</span><span class="hl-1"> | </span><span class="hl-7">undefined</span><span class="hl-1">,</span><br/><span class="hl-1">};</span><br/><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-8">patch</span><span class="hl-1"> = {</span><br/><span class="hl-1">  </span><span class="hl-5">name:</span><span class="hl-1"> </span><span class="hl-2">&#39;Alicia&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">note:</span><span class="hl-1"> </span><span class="hl-6">null</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">extra:</span><span class="hl-1"> </span><span class="hl-6">undefined</span><span class="hl-1"> </span><span class="hl-4">as</span><span class="hl-1"> </span><span class="hl-7">string</span><span class="hl-1"> | </span><span class="hl-7">undefined</span><span class="hl-1">,</span><br/><span class="hl-1">};</span><br/><br/><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-8">updated</span><span class="hl-1"> = </span><span class="hl-0">updateItem</span><span class="hl-1">(</span><span class="hl-5">original</span><span class="hl-1">, </span><span class="hl-5">patch</span><span class="hl-1">);</span><br/><span class="hl-3">// { id: 1, name: &#39;Alicia&#39; }  // note and extra are removed (null/undefined stripped)</span>
</code><button type="button">Copy</button></pre>

<p>Conditional execution</p>
<pre><code class="ts"><span class="hl-4">import</span><span class="hl-1"> { </span><span class="hl-5">conditionalize</span><span class="hl-1"> } </span><span class="hl-4">from</span><span class="hl-1"> </span><span class="hl-2">&#39;@karmaniverous/entity-tools&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-8">debugLog</span><span class="hl-1"> = </span><span class="hl-0">conditionalize</span><span class="hl-1">(</span><span class="hl-5">console</span><span class="hl-1">.</span><span class="hl-5">log</span><span class="hl-1">, </span><span class="hl-5">process</span><span class="hl-1">.</span><span class="hl-5">env</span><span class="hl-1">.</span><span class="hl-8">DEBUG</span><span class="hl-1">);</span><br/><span class="hl-0">debugLog</span><span class="hl-1">?.(</span><span class="hl-2">&#39;only logs when DEBUG is truthy&#39;</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<p>Nil checks</p>
<pre><code class="ts"><span class="hl-4">import</span><span class="hl-1"> { </span><span class="hl-5">isNil</span><span class="hl-1">, </span><span class="hl-4">type</span><span class="hl-1"> </span><span class="hl-5">Nil</span><span class="hl-1"> } </span><span class="hl-4">from</span><span class="hl-1"> </span><span class="hl-2">&#39;@karmaniverous/entity-tools&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-6">function</span><span class="hl-1"> </span><span class="hl-0">takesMaybe</span><span class="hl-1">(</span><span class="hl-5">v</span><span class="hl-1">: </span><span class="hl-7">unknown</span><span class="hl-1">): </span><span class="hl-5">v</span><span class="hl-1"> </span><span class="hl-6">is</span><span class="hl-1"> </span><span class="hl-7">Nil</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-4">return</span><span class="hl-1"> </span><span class="hl-0">isNil</span><span class="hl-1">(</span><span class="hl-5">v</span><span class="hl-1">);</span><br/><span class="hl-1">}</span>
</code><button type="button">Copy</button></pre>

<h2 id="transcoding" class="tsd-anchor-link">Transcoding<a href="#transcoding" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><h3 id="inference-first-builder-definetranscodes" class="tsd-anchor-link">Inference-first builder (defineTranscodes)<a href="#inference-first-builder-definetranscodes" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>The builder is value-first and inference-first: pass a literal registry and get a strongly-typed <code>Transcodes&lt;…&gt;</code> back with strict agreement between <code>encode</code> and <code>decode</code> per key.</p>
<pre><code class="ts"><span class="hl-4">import</span><span class="hl-1"> { </span><span class="hl-5">defineTranscodes</span><span class="hl-1"> } </span><span class="hl-4">from</span><span class="hl-1"> </span><span class="hl-2">&#39;@karmaniverous/entity-tools&#39;</span><span class="hl-1">;</span><br/><span class="hl-4">import</span><span class="hl-1"> </span><span class="hl-4">type</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-5">Transcodes</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">TranscodeRegistryFrom</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">TranscodedType</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">TranscodeName</span><span class="hl-1">,</span><br/><span class="hl-1">} </span><span class="hl-4">from</span><span class="hl-1"> </span><span class="hl-2">&#39;@karmaniverous/entity-tools&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-8">mySpec</span><span class="hl-1"> = {</span><br/><span class="hl-1">  </span><span class="hl-5">int:</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-0">encode</span><span class="hl-5">:</span><span class="hl-1"> (</span><span class="hl-5">v</span><span class="hl-1">: </span><span class="hl-7">number</span><span class="hl-1">) </span><span class="hl-6">=&gt;</span><span class="hl-1"> </span><span class="hl-5">v</span><span class="hl-1">.</span><span class="hl-0">toString</span><span class="hl-1">(),</span><br/><span class="hl-1">    </span><span class="hl-0">decode</span><span class="hl-5">:</span><span class="hl-1"> (</span><span class="hl-5">s</span><span class="hl-1">: </span><span class="hl-7">string</span><span class="hl-1">) </span><span class="hl-6">=&gt;</span><span class="hl-1"> </span><span class="hl-0">Number</span><span class="hl-1">(</span><span class="hl-5">s</span><span class="hl-1">),</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">  </span><span class="hl-5">boolean:</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-0">encode</span><span class="hl-5">:</span><span class="hl-1"> (</span><span class="hl-5">v</span><span class="hl-1">: </span><span class="hl-7">boolean</span><span class="hl-1">) </span><span class="hl-6">=&gt;</span><span class="hl-1"> (</span><span class="hl-5">v</span><span class="hl-1"> ? </span><span class="hl-2">&#39;t&#39;</span><span class="hl-1"> : </span><span class="hl-2">&#39;f&#39;</span><span class="hl-1">),</span><br/><span class="hl-1">    </span><span class="hl-0">decode</span><span class="hl-5">:</span><span class="hl-1"> (</span><span class="hl-5">s</span><span class="hl-1">: </span><span class="hl-7">string</span><span class="hl-1">) </span><span class="hl-6">=&gt;</span><span class="hl-1"> </span><span class="hl-5">s</span><span class="hl-1"> === </span><span class="hl-2">&#39;t&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">} </span><span class="hl-4">as</span><span class="hl-1"> </span><span class="hl-6">const</span><span class="hl-1">;</span><br/><br/><span class="hl-3">// Build the runtime registry (inference-first)</span><br/><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-8">myTranscodes</span><span class="hl-1"> = </span><span class="hl-0">defineTranscodes</span><span class="hl-1">(</span><span class="hl-5">mySpec</span><span class="hl-1">);</span><br/><span class="hl-3">//    ^? Transcodes&lt;TranscodeRegistryFrom&lt;typeof mySpec&gt;&gt;</span><br/><br/><span class="hl-3">// Extract the registry type without building:</span><br/><span class="hl-6">type</span><span class="hl-1"> </span><span class="hl-7">MyRegistry</span><span class="hl-1"> = </span><span class="hl-7">TranscodeRegistryFrom</span><span class="hl-1">&lt;</span><span class="hl-6">typeof</span><span class="hl-1"> </span><span class="hl-5">mySpec</span><span class="hl-1">&gt;;</span><br/><span class="hl-3">// Name and value helpers</span><br/><span class="hl-6">type</span><span class="hl-1"> </span><span class="hl-7">TInt</span><span class="hl-1"> = </span><span class="hl-7">TranscodedType</span><span class="hl-1">&lt;</span><span class="hl-7">MyRegistry</span><span class="hl-1">, </span><span class="hl-2">&#39;int&#39;</span><span class="hl-1">&gt;; </span><span class="hl-3">// number</span><br/><span class="hl-6">type</span><span class="hl-1"> </span><span class="hl-7">TNames</span><span class="hl-1"> = </span><span class="hl-7">TranscodeName</span><span class="hl-1">&lt;</span><span class="hl-7">MyRegistry</span><span class="hl-1">&gt;; </span><span class="hl-3">// &#39;int&#39; | &#39;boolean&#39;</span>
</code><button type="button">Copy</button></pre>

<p>Agreement is enforced at compile time: if <code>encode</code> and <code>decode</code> disagree for any key, the spec becomes unsatisfiable and TypeScript will error.</p>
<pre><code class="ts"><span class="hl-4">import</span><span class="hl-1"> { </span><span class="hl-5">defineTranscodes</span><span class="hl-1"> } </span><span class="hl-4">from</span><span class="hl-1"> </span><span class="hl-2">&#39;@karmaniverous/entity-tools&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-3">// @ts-expect-error encode/decode types do not agree</span><br/><span class="hl-0">defineTranscodes</span><span class="hl-1">({</span><br/><span class="hl-1">  </span><span class="hl-5">bad:</span><span class="hl-1"> {</span><br/><span class="hl-1">    </span><span class="hl-0">encode</span><span class="hl-5">:</span><span class="hl-1"> (</span><span class="hl-5">_v</span><span class="hl-1">: </span><span class="hl-7">unknown</span><span class="hl-1">) </span><span class="hl-6">=&gt;</span><span class="hl-1"> </span><span class="hl-2">&#39;&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">    </span><span class="hl-3">// wrong decode return type on purpose:</span><br/><span class="hl-1">    </span><span class="hl-0">decode</span><span class="hl-5">:</span><span class="hl-1"> (</span><span class="hl-5">_s</span><span class="hl-1">: </span><span class="hl-7">string</span><span class="hl-1">) </span><span class="hl-6">=&gt;</span><span class="hl-1"> </span><span class="hl-2">&#39;oops&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  },</span><br/><span class="hl-1">} </span><span class="hl-4">as</span><span class="hl-1"> </span><span class="hl-6">const</span><span class="hl-1">);</span>
</code><button type="button">Copy</button></pre>

<h3 id="branded-error-shapes-clearer-type-errors" class="tsd-anchor-link">Branded error shapes (clearer type errors)<a href="#branded-error-shapes-clearer-type-errors" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><p>To improve DX, unsatisfied keys are branded in the agreement type so the compiler produces clearer error messages during development:</p>
<ul>
<li>Missing encode function:
<ul>
<li><code>{ __error__: 'MissingEncode'; key: K }</code></li>
</ul>
</li>
<li>Missing decode function:
<ul>
<li><code>{ __error__: 'MissingDecode'; key: K }</code></li>
</ul>
</li>
<li>Mismatch (encode/decode disagreement):
<ul>
<li><code>{ __error__: 'EncodeDecodeMismatch'; key: K; encodeParam: VK; decodeReturn: VK' }</code></li>
</ul>
</li>
</ul>
<p>These branded shapes are used by the agreement type internally; the builder still rejects invalid specs, but the branded shapes help the compiler show more actionable messages when a spec is incorrect.</p>
<p>Example (type-only):</p>
<pre><code class="ts"><span class="hl-4">import</span><span class="hl-1"> </span><span class="hl-4">type</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-5">EncodeDecodeAgreement</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">EncodeDecodeMismatchError</span><span class="hl-1">,</span><br/><span class="hl-1">} </span><span class="hl-4">from</span><span class="hl-1"> </span><span class="hl-2">&#39;@karmaniverous/entity-tools&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-3">// Produces a branded mismatch error for key &#39;bad&#39;</span><br/><span class="hl-6">type</span><span class="hl-1"> </span><span class="hl-7">Mismatch</span><span class="hl-1"> = </span><span class="hl-7">EncodeDecodeAgreement</span><span class="hl-1">&lt;{</span><br/><span class="hl-1">  </span><span class="hl-5">bad</span><span class="hl-1">: { </span><span class="hl-0">encode</span><span class="hl-1">: (</span><span class="hl-5">v</span><span class="hl-1">: </span><span class="hl-7">number</span><span class="hl-1">) </span><span class="hl-6">=&gt;</span><span class="hl-1"> </span><span class="hl-7">string</span><span class="hl-1">; </span><span class="hl-0">decode</span><span class="hl-1">: (</span><span class="hl-5">s</span><span class="hl-1">: </span><span class="hl-7">string</span><span class="hl-1">) </span><span class="hl-6">=&gt;</span><span class="hl-1"> </span><span class="hl-7">boolean</span><span class="hl-1"> };</span><br/><span class="hl-1">}&gt;;</span><br/><br/><span class="hl-3">// Assignable to a branded error shape:</span><br/><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-8">sample</span><span class="hl-1">: </span><span class="hl-7">EncodeDecodeMismatchError</span><span class="hl-1">&lt;</span><span class="hl-2">&#39;bad&#39;</span><span class="hl-1">, </span><span class="hl-7">number</span><span class="hl-1">, </span><span class="hl-7">boolean</span><span class="hl-1">&gt; = {</span><br/><span class="hl-1">  </span><span class="hl-5">__error__:</span><span class="hl-1"> </span><span class="hl-2">&#39;EncodeDecodeMismatch&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">key:</span><span class="hl-1"> </span><span class="hl-2">&#39;bad&#39;</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">encodeParam:</span><span class="hl-1"> </span><span class="hl-9">1</span><span class="hl-1"> </span><span class="hl-4">as</span><span class="hl-1"> </span><span class="hl-7">number</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">decodeReturn:</span><span class="hl-1"> </span><span class="hl-6">true</span><span class="hl-1"> </span><span class="hl-4">as</span><span class="hl-1"> </span><span class="hl-7">boolean</span><span class="hl-1">,</span><br/><span class="hl-1">};</span>
</code><button type="button">Copy</button></pre>

<h3 id="notes-on-default-transcoding" class="tsd-anchor-link">Notes on default transcoding<a href="#notes-on-default-transcoding" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><ul>
<li>Keys supported by DefaultTranscodeRegistry:
<ul>
<li>boolean → &quot;t&quot;/&quot;f&quot; (fixed width)</li>
<li>string → identity (variable width)</li>
<li>number → decimal string (variable width)</li>
<li>fix6 → signed fixed width with 6 decimals, padded; sorts lexicographically</li>
<li>int → signed fixed-width integer, padded; sorts lexicographically</li>
<li>bigint → decimal string (variable width)</li>
<li>bigint20 → signed fixed-width BigInt up to 20 digits; sorts lexicographically</li>
<li>timestamp → fixed-width 13-digit UNIX millis, padded</li>
</ul>
</li>
<li>Encoders throw on invalid inputs; decoders throw on invalid encoded strings.</li>
<li>For custom maps, define your own TranscodeRegistry using defineTranscodes (inference-first).</li>
</ul>
<h3 id="quick-examples-1" class="tsd-anchor-link">Quick examples<a href="#quick-examples-1" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h3><pre><code class="ts"><span class="hl-4">import</span><span class="hl-1"> { </span><span class="hl-5">defaultTranscodes</span><span class="hl-1"> } </span><span class="hl-4">from</span><span class="hl-1"> </span><span class="hl-2">&#39;@karmaniverous/entity-tools&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-3">// Fixed-width integer (sign-prefixed, zero-padded; sorts lexicographically)</span><br/><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-8">enc</span><span class="hl-1"> = </span><span class="hl-5">defaultTranscodes</span><span class="hl-1">.</span><span class="hl-5">int</span><span class="hl-1">.</span><span class="hl-0">encode</span><span class="hl-1">(-</span><span class="hl-9">123</span><span class="hl-1">); </span><span class="hl-3">// &quot;n0000000000000123&quot;</span><br/><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-8">dec</span><span class="hl-1"> = </span><span class="hl-5">defaultTranscodes</span><span class="hl-1">.</span><span class="hl-5">int</span><span class="hl-1">.</span><span class="hl-0">decode</span><span class="hl-1">(</span><span class="hl-5">enc</span><span class="hl-1">); </span><span class="hl-3">// -123</span><br/><br/><span class="hl-3">// Fixed 6-decimal number</span><br/><span class="hl-5">defaultTranscodes</span><span class="hl-1">.</span><span class="hl-5">fix6</span><span class="hl-1">.</span><span class="hl-0">encode</span><span class="hl-1">(</span><span class="hl-9">123.45</span><span class="hl-1">); </span><span class="hl-3">// &quot;p0000000123.450000&quot;</span><br/><span class="hl-5">defaultTranscodes</span><span class="hl-1">.</span><span class="hl-5">fix6</span><span class="hl-1">.</span><span class="hl-0">decode</span><span class="hl-1">(</span><span class="hl-2">&#39;n0000000123.450000&#39;</span><span class="hl-1">); </span><span class="hl-3">// -123.45</span><br/><br/><span class="hl-3">// Variable width number, boolean, string</span><br/><span class="hl-5">defaultTranscodes</span><span class="hl-1">.</span><span class="hl-5">number</span><span class="hl-1">.</span><span class="hl-0">encode</span><span class="hl-1">(</span><span class="hl-9">42</span><span class="hl-1">); </span><span class="hl-3">// &quot;42&quot;</span><br/><span class="hl-5">defaultTranscodes</span><span class="hl-1">.</span><span class="hl-5">boolean</span><span class="hl-1">.</span><span class="hl-0">decode</span><span class="hl-1">(</span><span class="hl-2">&#39;t&#39;</span><span class="hl-1">); </span><span class="hl-3">// true</span><br/><span class="hl-5">defaultTranscodes</span><span class="hl-1">.</span><span class="hl-5">string</span><span class="hl-1">.</span><span class="hl-0">encode</span><span class="hl-1">(</span><span class="hl-2">&#39;hello&#39;</span><span class="hl-1">); </span><span class="hl-3">// &quot;hello&quot;</span><br/><br/><span class="hl-3">// BigInt (variable) and BigInt20 (fixed width up to 20 digits)</span><br/><span class="hl-5">defaultTranscodes</span><span class="hl-1">.</span><span class="hl-5">bigint</span><span class="hl-1">.</span><span class="hl-0">encode</span><span class="hl-1">(</span><span class="hl-9">1234567890123456789</span><span class="hl-6">n</span><span class="hl-1">); </span><span class="hl-3">// &quot;1234567890123456789&quot;</span><br/><span class="hl-5">defaultTranscodes</span><span class="hl-1">.</span><span class="hl-5">bigint20</span><span class="hl-1">.</span><span class="hl-0">encode</span><span class="hl-1">(-</span><span class="hl-9">1234567890123456789</span><span class="hl-6">n</span><span class="hl-1">); </span><span class="hl-3">// &quot;n01234567890123456789&quot;</span>
</code><button type="button">Copy</button></pre>

<h2 id="kv-codec-helpers" class="tsd-anchor-link">KV codec helpers<a href="#kv-codec-helpers" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><pre><code class="ts"><span class="hl-4">import</span><span class="hl-1"> { </span><span class="hl-5">encodePairs</span><span class="hl-1">, </span><span class="hl-5">decodePairs</span><span class="hl-1"> } </span><span class="hl-4">from</span><span class="hl-1"> </span><span class="hl-2">&#39;@karmaniverous/entity-tools&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-8">pairs</span><span class="hl-1">: </span><span class="hl-7">Array</span><span class="hl-1">&lt;[</span><span class="hl-7">string</span><span class="hl-1">, </span><span class="hl-7">string</span><span class="hl-1">]&gt; = [</span><br/><span class="hl-1">  [</span><span class="hl-2">&#39;k1&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;v1&#39;</span><span class="hl-1">],</span><br/><span class="hl-1">  [</span><span class="hl-2">&#39;k2&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;&#39;</span><span class="hl-1">],</span><br/><span class="hl-1">];</span><br/><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-8">enc</span><span class="hl-1"> = </span><span class="hl-0">encodePairs</span><span class="hl-1">(</span><span class="hl-5">pairs</span><span class="hl-1">); </span><span class="hl-3">// &#39;k1#v1|k2#&#39;</span><br/><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-8">dec</span><span class="hl-1"> = </span><span class="hl-0">decodePairs</span><span class="hl-1">(</span><span class="hl-5">enc</span><span class="hl-1">); </span><span class="hl-3">// pairs</span><br/><br/><span class="hl-3">// custom delimiters</span><br/><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-8">enc2</span><span class="hl-1"> = </span><span class="hl-0">encodePairs</span><span class="hl-1">(</span><span class="hl-5">pairs</span><span class="hl-1">, { </span><span class="hl-5">pair:</span><span class="hl-1"> </span><span class="hl-2">&#39;~&#39;</span><span class="hl-1">, </span><span class="hl-5">kv:</span><span class="hl-1"> </span><span class="hl-2">&#39;::&#39;</span><span class="hl-1"> }); </span><span class="hl-3">// &#39;k1::v1~k2::&#39;</span><br/><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-8">dec2</span><span class="hl-1"> = </span><span class="hl-0">decodePairs</span><span class="hl-1">(</span><span class="hl-5">enc2</span><span class="hl-1">, { </span><span class="hl-5">pair:</span><span class="hl-1"> </span><span class="hl-2">&#39;~&#39;</span><span class="hl-1">, </span><span class="hl-5">kv:</span><span class="hl-1"> </span><span class="hl-2">&#39;::&#39;</span><span class="hl-1"> }); </span><span class="hl-3">// pairs</span>
</code><button type="button">Copy</button></pre>

<h2 id="sharding-math-helpers" class="tsd-anchor-link">Sharding math helpers<a href="#sharding-math-helpers" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><pre><code class="ts"><span class="hl-4">import</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-5">hashString</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">enumerateShardSuffixes</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">shardSuffixFromHash</span><span class="hl-1">,</span><br/><span class="hl-1">} </span><span class="hl-4">from</span><span class="hl-1"> </span><span class="hl-2">&#39;@karmaniverous/entity-tools&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-3">// hashString: deterministic 32-bit unsigned FNV-1a</span><br/><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-8">h</span><span class="hl-1"> = </span><span class="hl-0">hashString</span><span class="hl-1">(</span><span class="hl-2">&#39;hello&#39;</span><span class="hl-1">); </span><span class="hl-3">// number in [0, 2^32 - 1]</span><br/><br/><span class="hl-3">// enumerateShardSuffixes: all suffixes for radix/width</span><br/><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-8">hex2</span><span class="hl-1"> = </span><span class="hl-0">enumerateShardSuffixes</span><span class="hl-1">(</span><span class="hl-9">16</span><span class="hl-1">, </span><span class="hl-9">2</span><span class="hl-1">); </span><span class="hl-3">// [&#39;00&#39;, &#39;01&#39;, ..., &#39;ff&#39;]</span><br/><br/><span class="hl-3">// shardSuffixFromHash: modulo shard space with padding</span><br/><span class="hl-6">const</span><span class="hl-1"> </span><span class="hl-8">s</span><span class="hl-1"> = </span><span class="hl-0">shardSuffixFromHash</span><span class="hl-1">(</span><span class="hl-5">h</span><span class="hl-1">, </span><span class="hl-9">16</span><span class="hl-1">, </span><span class="hl-9">2</span><span class="hl-1">); </span><span class="hl-3">// e.g., &#39;a3&#39;</span>
</code><button type="button">Copy</button></pre>

<h2 id="type-only-helpers-samples" class="tsd-anchor-link">Type-only helpers (samples)<a href="#type-only-helpers-samples" aria-label="Permalink" class="tsd-anchor-icon"><svg viewBox="0 0 24 24" aria-hidden="true"><use href="assets/icons.svg#icon-anchor"></use></svg></a></h2><pre><code class="ts"><span class="hl-4">import</span><span class="hl-1"> </span><span class="hl-4">type</span><span class="hl-1"> {</span><br/><span class="hl-1">  </span><span class="hl-5">MakeOptional</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">MakeRequired</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">MakeUpdatable</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">WithRequiredAndNonNullable</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">MutuallyExclusive</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">PropertiesOfType</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">PropertiesNotOfType</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">ReplaceKey</span><span class="hl-1">,</span><br/><span class="hl-1">  </span><span class="hl-5">ReplaceKeys</span><span class="hl-1">,</span><br/><span class="hl-1">} </span><span class="hl-4">from</span><span class="hl-1"> </span><span class="hl-2">&#39;@karmaniverous/entity-tools&#39;</span><span class="hl-1">;</span><br/><br/><span class="hl-6">type</span><span class="hl-1"> </span><span class="hl-7">User</span><span class="hl-1"> = { </span><span class="hl-5">id</span><span class="hl-1">: </span><span class="hl-7">number</span><span class="hl-1">; </span><span class="hl-5">name</span><span class="hl-1">: </span><span class="hl-7">string</span><span class="hl-1">; </span><span class="hl-5">note</span><span class="hl-1">?: </span><span class="hl-7">string</span><span class="hl-1"> | </span><span class="hl-7">null</span><span class="hl-1"> };</span><br/><span class="hl-6">type</span><span class="hl-1"> </span><span class="hl-7">OptionalNote</span><span class="hl-1"> = </span><span class="hl-7">MakeOptional</span><span class="hl-1">&lt;</span><span class="hl-7">User</span><span class="hl-1">, </span><span class="hl-2">&#39;note&#39;</span><span class="hl-1">&gt;;</span><br/><span class="hl-6">type</span><span class="hl-1"> </span><span class="hl-7">RequiredId</span><span class="hl-1"> = </span><span class="hl-7">WithRequiredAndNonNullable</span><span class="hl-1">&lt;</span><span class="hl-7">User</span><span class="hl-1">, </span><span class="hl-2">&#39;id&#39;</span><span class="hl-1">&gt;;</span><br/><br/><span class="hl-3">// Compile-time exclusivity check (returns true or an error-shape).</span><br/><span class="hl-6">type</span><span class="hl-1"> </span><span class="hl-7">Ex</span><span class="hl-1"> = </span><span class="hl-7">MutuallyExclusive</span><span class="hl-1">&lt;[</span><span class="hl-2">&#39;a&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;b&#39;</span><span class="hl-1"> | </span><span class="hl-2">&#39;c&#39;</span><span class="hl-1">, </span><span class="hl-2">&#39;d&#39;</span><span class="hl-1">]&gt;; </span><span class="hl-3">// true</span>
</code><button type="button">Copy</button></pre>

<hr>
<p>Built for you with ❤️ on Bali! Find more great tools &amp; templates on <a href="https://github.com/karmaniverous" target="_blank" class="external">my GitHub Profile</a>.</p>
</div></div><div class="col-sidebar"><div class="page-menu"><div class="tsd-navigation settings"><details class="tsd-accordion"><summary class="tsd-accordion-summary"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="assets/icons.svg#icon-chevronDown"></use></svg><h3>Settings</h3></summary><div class="tsd-accordion-details"><div class="tsd-filter-visibility"><span class="settings-label">Member Visibility</span><ul id="tsd-filter-options"><li class="tsd-filter-item"><label class="tsd-filter-input"><input type="checkbox" id="tsd-filter-protected" name="protected"/><svg width="32" height="32" viewBox="0 0 32 32" aria-hidden="true"><rect class="tsd-checkbox-background" width="30" height="30" x="1" y="1" rx="6" fill="none"></rect><path class="tsd-checkbox-checkmark" d="M8.35422 16.8214L13.2143 21.75L24.6458 10.25" stroke="none" stroke-width="3.5" stroke-linejoin="round" fill="none"></path></svg><span>Protected</span></label></li></ul></div><div class="tsd-theme-toggle"><label class="settings-label" for="tsd-theme">Theme</label><select id="tsd-theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></div></div></details></div><details open class="tsd-accordion tsd-page-navigation"><summary class="tsd-accordion-summary"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" aria-hidden="true"><use href="assets/icons.svg#icon-chevronDown"></use></svg><h3>On This Page</h3></summary><div class="tsd-accordion-details"><a href="#entity-tools"><span>Entity <wbr/>Tools</span></a><ul><li><a href="#installation"><span>Installation</span></a></li><li><a href="#exports-overview"><span>Exports overview</span></a></li><li><a href="#quick-examples"><span>Quick examples</span></a></li><li><a href="#transcoding"><span>Transcoding</span></a></li><li><ul><li><a href="#inference-first-builder-definetranscodes"><span>Inference-<wbr/>first builder (define<wbr/>Transcodes)</span></a></li><li><a href="#branded-error-shapes-clearer-type-errors"><span>Branded error shapes (clearer type errors)</span></a></li><li><a href="#notes-on-default-transcoding"><span>Notes on default transcoding</span></a></li><li><a href="#quick-examples-1"><span>Quick examples</span></a></li></ul></li><li><a href="#kv-codec-helpers"><span>KV codec helpers</span></a></li><li><a href="#sharding-math-helpers"><span>Sharding math helpers</span></a></li><li><a href="#type-only-helpers-samples"><span>Type-<wbr/>only helpers (samples)</span></a></li></ul></div></details></div><div class="site-menu"><nav id="tsd-sidebar-links" class="tsd-navigation"><a href="https://github.com/karmaniverous/entity-tools" class="tsd-nav-link">GitHub</a></nav><nav class="tsd-navigation"><a href="modules.html">@karmaniverous/entity-tools</a><ul class="tsd-small-nested-navigation" id="tsd-nav-container"><li>Loading...</li></ul></nav></div></div></div><footer><p class="tsd-generator">Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></footer><div class="overlay"></div></body></html>
